<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>KALEIDOSCOPE - ãƒ“ãƒ¼ç‰ä¸‡è¯é¡</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body{
  margin:0;
  height:100vh;
  background:#fff;
  transition:background-color 2.5s ease;
  overflow:hidden;
}
canvas{
  position:absolute;
  inset:0;
}
#controls{
  position:fixed;
  bottom:12px;
  left:50%;
  transform:translateX(-50%);
  background:rgba(0,0,0,.6);
  padding:10px 14px;
  border-radius:10px;
  display:flex;
  gap:10px;
  z-index:10;
}
#controls input, #controls button{
  font-size:12px;
}
</style>
</head>

<body>

<div id="controls">
  <input type="file" id="imageLoader" accept="image/*" multiple>
  <input type="range" id="sliceRange" min="0" max="24" value="12">
  <button id="gyroBtn">ğŸŒ€ ã‚¸ãƒ£ã‚¤ãƒ­ON</button>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const imageLoader = document.getElementById("imageLoader");
const sliceRange = document.getElementById("sliceRange");
const gyroBtn = document.getElementById("gyroBtn");

function resize(){
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

// ===== çŠ¶æ…‹ =====
let images=[], idx=0;
let angle=0, rotVel=0;
let gyroX=0, gyroY=0;
let gyroEnabled=false;

let offsetX=0, offsetY=0;
let velX=0, velY=0;

// ===== ã‚¸ãƒ£ã‚¤ãƒ­è¨±å¯ =====
gyroBtn.onclick = async ()=>{
  if(typeof DeviceOrientationEvent?.requestPermission==="function"){
    const res = await DeviceOrientationEvent.requestPermission();
    if(res!=="granted") return;
  }
  gyroEnabled=true;
  gyroBtn.textContent="ğŸŒ€ ã‚¸ãƒ£ã‚¤ãƒ­ONâœ”";
};

addEventListener("deviceorientation",e=>{
  if(!gyroEnabled) return;
  gyroX = e.gamma || 0; // æ¨ª
  gyroY = e.beta  || 0; // å‰å¾Œ
});

// ===== å´é¢ã‚¿ãƒƒãƒ—ï¼šç”»åƒåˆ‡æ›¿ =====
let tapLock=false;
addEventListener("devicemotion",e=>{
  if(!images.length || tapLock) return;
  const a=e.accelerationIncludingGravity;
  if(!a) return;

  const power = Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z);
  if(power>35){
    tapLock=true;
    idx=(idx+1)%images.length;
    setTimeout(()=>tapLock=false,600);
  }
});

// ===== ç”»åƒãƒ­ãƒ¼ãƒ‰ =====
imageLoader.onchange=()=>{
  images=[];
  idx=0;
  for(const f of imageLoader.files){
    const img=new Image();
    img.src=URL.createObjectURL(f);
    images.push(img);
  }
};

// ===== æç”» =====
function draw(){
  requestAnimationFrame(draw);
  if(!images.length) return;

  const img=images[idx];
  const w=canvas.width, h=canvas.height;
  const cx=w/2, cy=h/2;
  const r=Math.min(w,h)*0.48;

  // --- å›è»¢ï¼ˆæ¨ªå‚¾ãï¼‰ ---
  rotVel += gyroX * 0.00015;
  rotVel *= 0.92;                 // æ¸›è¡°
  rotVel = Math.max(Math.min(rotVel,0.02),-0.02);
  angle += rotVel;

  // --- ä½ç½®ç§»å‹•ï¼ˆå‰å¾Œå‚¾ãï¼‹æºã‚‰ãï¼‰ ---
  velX += (Math.sin(Date.now()*0.001)+gyroY*0.02)*0.03;
  velY += (Math.cos(Date.now()*0.0013)+gyroY*0.02)*0.03;
  velX *= 0.9;
  velY *= 0.9;
  offsetX += velX;
  offsetY += velY;

  ctx.clearRect(0,0,w,h);

  ctx.save();
  ctx.beginPath();
  ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.clip();

  const s=Math.max(r*2/img.width,r*2/img.height)*1.4;
  const iw=img.width*s, ih=img.height*s;

  const n=+sliceRange.value;
  if(n===0){
    ctx.translate(cx,cy);
    ctx.rotate(angle);
    ctx.drawImage(img,-iw/2+offsetX,-ih/2+offsetY,iw,ih);
  }else{
    const a2=Math.PI*2/n;
    for(let i=0;i<n;i++){
      ctx.save();
      ctx.translate(cx,cy);
      ctx.rotate(i*a2+angle);
      ctx.beginPath();
      const w2=r*1.8,h2=Math.tan(a2/2)*w2;
      ctx.moveTo(0,0);
      ctx.lineTo(w2,-h2);
      ctx.lineTo(w2,h2);
      ctx.closePath();
      ctx.clip();
      if(i%2) ctx.scale(-1,1);
      ctx.drawImage(img,-iw/2+offsetX,-ih/2+offsetY,iw,ih);
      ctx.restore();
    }
  }
  ctx.restore();
}
requestAnimationFrame(draw);
</script>
</body>
</html>
