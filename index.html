<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ゆもちのiPhone専用ビー玉万華鏡</title>
<style>
  body { margin:0; background:#000; display:flex; flex-direction:column; height:100vh; color:white; font-family:sans-serif; overflow:hidden; }
  #controls { padding:10px; background:rgba(0,0,0,0.5); display:flex; gap:15px; flex-wrap:wrap; align-items:center; z-index:10; }
  label { font-size:13px; display:flex; flex-direction:column; }
  canvas { flex:1; display:block; }
</style>
</head>
<body>
<div id="controls">
  <input type="file" id="imageLoader" accept="image/*" multiple>

  <label>回転スピード
    <input type="range" id="speedRange" min="-2" max="2" step="0.01" value="0.5">
  </label>

  <label>分割数（0〜24）
    <input type="range" id="sliceRange" min="0" max="24" step="1" value="12">
  </label>
</div>

<canvas id="canvas"></canvas>

<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

function resizeCanvas(){
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
resizeCanvas();
window.addEventListener("resize", resizeCanvas);

const imageLoader = document.getElementById("imageLoader");
const speedRange = document.getElementById("speedRange");
const sliceRange = document.getElementById("sliceRange");

let images = [];
let currentIndex = 0;
let fade = 1;

imageLoader.addEventListener("change", () => {
  images = [];
  currentIndex = 0;
  for(let file of imageLoader.files){
    const img = new Image();
    img.src = URL.createObjectURL(file);
    img.onload = ()=>draw(0);
    images.push(img);
  }
});

window.addEventListener("wheel",(e)=>{
  if(images.length===0) return;
  fade=0;
  if(e.deltaY>0) currentIndex=(currentIndex+1)%images.length;
  else currentIndex=(currentIndex-1+images.length)%images.length;
});

let angle=0,lastTime=0,moveStrength=200;

// iPhoneジャイロ用
let gyroX=0,gyroY=0;
window.addEventListener("deviceorientation",(event)=>{
  gyroX = event.gamma || 0; // 左右傾き
  gyroY = event.beta || 0;  // 前後傾き
});

function draw(timestamp){
  requestAnimationFrame(draw);
  if(images.length===0) return;
  const img = images[currentIndex];

  const now = timestamp||0;
  const delta = lastTime ? (now-lastTime)/1000 :0;
  lastTime=now;

  const w=canvas.width,h=canvas.height,cx=w/2,cy=h/2;
  const radius=Math.min(w,h)*0.48;

  let speed=parseFloat(speedRange.value);
  let slices=parseInt(sliceRange.value);

  angle += speed*delta + gyroX*0.002; // ジャイロ反映

  if(fade<1) fade+=0.05;
  ctx.globalAlpha=fade;
  ctx.clearRect(0,0,w,h);

  // 円マスク
  ctx.save();
  ctx.beginPath();
  ctx.arc(cx,cy,radius,0,Math.PI*2);
  ctx.clip();

  const scale=Math.max((radius*2)/img.width,(radius*2)/img.height)*1.4;
  const iw=img.width*scale, ih=img.height*scale;

  const moveX=Math.cos(timestamp*0.00025)*moveStrength + gyroX*2;
  const moveY=Math.sin(timestamp*0.00022)*moveStrength + gyroY*2;

  if(slices===0){
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(angle);
    ctx.drawImage(img,-iw/2+moveX,-ih/2+moveY,iw,ih);
    ctx.restore();
    ctx.restore();
    ctx.globalAlpha=1;
    return;
  }

  const sliceAngle=(Math.PI*2)/slices;
  for(let i=0;i<slices;i++){
    ctx.save();
    ctx.translate(cx,cy);
    ctx.rotate(sliceAngle*i+angle);
    ctx.beginPath();
    const clipW=radius*1.8;
    const half=Math.tan(sliceAngle/2)*clipW;
    ctx.moveTo(0,0);
    ctx.lineTo(clipW,-half);
    ctx.lineTo(clipW,half);
    ctx.closePath();
    ctx.clip();
    if(i%2===1) ctx.scale(-1,1);
    ctx.drawImage(img,-iw/2+moveX,-ih/2+moveY,iw,ih);
    ctx.restore();
  }

  ctx.restore();
  ctx.globalAlpha=1;
}

requestAnimationFrame(draw);
</script>
</body>
</html>
